navigator.geolocation.getCurrentPosition(localizarPredio);

let predios = [{
    nome: "bandex",
    circulos: [{
        raio: 0.00010470912090127272,
        centro: {
          x: -19.939239,
          y: -43.999947
        }
      },
      {
        raio: 0.00010470912090127272,
        centro: {
          x: -19.939178,
          y: -43.999823
        }
      },
      {
        raio: 0.00010470912090127272,
        centro: {
          x: -19.939091,
          y: -43.999664
        }
      }
    ],
    videos: {
      principal: '',
      p20: '',
      decom: '',
      p18: '',
      p4: '',
      p5: '',
      depart: '',
      biblioteca: '',
      oficinas: '',
      p12: '',
      p8e9: '',
      cemig: '',
      p19: '',
      portaria: ''
    }
  },
  {
    nome: "p20",
    circulos: [{
        raio: 0.00013370115930708704,
        centro: {
          x: -19.938832,
          y: -43.999809
        }
      },
      {
        raio: 0.00013370115930708704,
        centro: {
          x: -19.938914,
          y: -43.999958
        }
      },
      {
        raio: 0.00013370115930708704,
        centro: {
          x: -19.939004,
          y: -44.000108
        }
      },
    ],
    videos: {
      bandex: '',
      decom: '',
      principal: '',
      p18: '',
      p4: '',
      p5: '',
      depart: '',
      biblioteca: '',
      oficinas: '',
      p12: '',
      p8e9: '',
      cemig: '',
      p19: '',
      portaria: ''
    }
  },
  {
    nome: "decom",
    circulos: [{
      raio: 0.00011535163631348725,
      centro: {
        x: -19.939583,
        y: -43.998186
      }
    }],
    videos: {
      bandex: '',
      p20: '',
      principal: '',
      p18: '',
      p4: '',
      p5: '',
      depart: '',
      biblioteca: '',
      oficinas: '',
      p12: '',
      p8e9: '',
      cemig: '',
      p19: '',
      portaria: ''
    }
  },
  {
    nome: "principal",
    circulos: [{
        raio: 0.00011374532957721413,
        centro: {
          x: -19.938619,
          y: -43.998829
        }
      },
      {
        raio: 0.00011374532957721413,
        centro: {
          x: -19.939047,
          y: -43.999272
        }
      },
      {
        raio: 0.00011374532957721413,
        centro: {
          x: -19.938986,
          y: -43.999152
        }
      },
      {
        raio: 0.00011374532957721413,
        centro: {
          x: -19.938905,
          y: -43.999006
        }
      },
      {
        raio: 0.00011374532957721413,
        centro: {
          x: -19.938802,
          y: -43.998837
        }
      },
      {
        raio: 0.00011374532957721413,
        centro: {
          x: -19.938696,
          y: -43.998676
        }
      },
      {
        raio: 0.00011374532957721413,
        centro: {
          x: -19.938615,
          y: -43.998558
        }
      },
      {
        raio: 0.00011374532957721413,
        centro: {
          x: -19.938902,
          y: -43.998703
        }
      },
      {
        raio: 0.00011374532957721413,
        centro: {
          x: -19.939054,
          y: -43.998636
        }
      },
      {
        raio: 0.00011374532957721413,
        centro: {
          x: -19.939104,
          y: -43.998542
        }
      },
      {
        raio: 0.00011374532957721413,
        centro: {
          x: -19.939213,
          y: -43.998714
        }
      },
      {
        raio: 0.00011374532957721413,
        centro: {
          x: -19.939281,
          y: -43.998835
        }
      },
      {
        raio: 0.00011374532957721413,
        centro: {
          x: -19.939376,
          y: -43.999022
        }
      }
    ],
    videos: {
      bandex: '',
      p20: '',
      decom: '',
      p18: '',
      p4: '',
      p5: '',
      depart: '',
      biblioteca: '',
      oficinas: '',
      p12: '',
      p8e9: '',
      cemig: '',
      p19: '',
      portaria: ''
    }
  },
  {
    nome: "p18",
    circulos: [{
      raio: 0.00015009663554410555,
      centro: {
        x: -19.939968,
        y: -43.998949
      }
    }],
    videos: {
      bandex: '',
      p20: '',
      principal: '',
      decom: '',
      p5: '',
      p4: '',
      depart: '',
      biblioteca: '',
      oficinas: '',
      p12: '',
      p8e9: '',
      cemig: '',
      p19: '',
      portaria: ''
    }
  },
  {
    nome: "p5",
    circulos: [{
        raio: 0.00009716995420030493,
        centro: {
          x: -19.939590,
          y: -44.000281
        }
      },
      {
        raio: 0.00009716995420030493,
        centro: {
          x: -19.939653,
          y: -44.000247
        }
      }
    ],
    videos: {
      bandex: '',
      p20: '',
      principal: '',
      decom: '',
      p18: '',
      p4: '',
      depart: '',
      biblioteca: '',
      oficinas: '',
      p12: '',
      p8e9: '',
      cemig: '',
      p19: '',
      portaria: ''
    }
  },
  {
    nome: "p4",
    circulos: [{
        raio: 0.0000924391691864567,
        centro: {
          x: -19.939511,
          y: -44.000113
        }
      },
      {
        raio: 0.0000924391691864567,
        centro: {
          x: -19.939623,
          y: -44.000038
        }
      },
      {
        raio: 0.0000924391691864567,
        centro: {
          x: -19.939697,
          y: -43.999992
        }
      }
    ],
    videos: {
      bandex: '',
      p20: '',
      principal: '',
      decom: '',
      p5: '',
      p18: '',
      depart: '',
      biblioteca: '',
      oficinas: '',
      p12: '',
      p8e9: '',
      cemig: '',
      p19: '',
      portaria: ''
    }
  },
  {
    nome: "depart",
    circulos: [{
      raio: 0.00015482893786553448,
      centro: {
        x: -19.939577,
        y: -43.999713
      }
    }],
    videos: {
      bandex: '',
      p20: '',
      principal: '',
      decom: '',
      p5: '',
      p4: '',
      p18: '',
      biblioteca: '',
      oficinas: '',
      p12: '',
      p8e9: '',
      cemig: '',
      p19: '',
      portaria: '',
    }
  },
  {
    nome: "biblioteca",
    circulos: [{
      raio: 0.00013771347065699022,
      centro: {
        x: -19.939435,
        y: -43.999485
      }
    }],
    videos: {
      bandex: '',
      p20: '',
      principal: '',
      decom: '',
      p5: '',
      p4: '',
      p18: '',
      depart: '',
      oficinas: '',
      p12: '',
      p8e9: '',
      cemig: '',
      p19: '',
      portaria: ''
    }
  },
  {
    nome: "oficinas",
    circulos: [{
        raio: 0.00008415461960110693,
        centro: {
          x: -19.939259,
          y: -44.000506
        }
      },
      {
        raio: 0.00008415461960110693,
        centro: {
          x: -19.939409,
          y: -44.000565
        }
      }
    ],
    videos: {
      bandex: '',
      p20: '',
      principal: '',
      decom: '',
      p18: '',
      p4: '',
      p5: '',
      depart: '',
      biblioteca: '',
      p12: '',
      p8e9: '',
      cemig: '',
      p19: '',
      portaria: ''
    }
  },
  {
    nome: "p12",
    circulos: [{
        raio: 0.0001333304166351025,
        centro: {
          x: -19.939851,
          y: -43.99830
        }
      },
      {
        raio: 0.0001333304166351025,
        centro: {
          x: -19.939947,
          y: -43.998472
        }
      },
      {
        raio: 0.0001333304166351025,
        centro: {
          x: -19.940029,
          y: -43.998636
        }
      }
    ],
    videos: {
      bandex: '',
      p20: '',
      principal: '',
      decom: '',
      p18: '',
      p4: '',
      p5: '',
      depart: '',
      biblioteca: '',
      oficinas: '',
      p8e9: '',
      cemig: '',
      p19: '',
      portaria: ''
    }
  },
  {
    nome: "p8e9",
    circulos: [{
        raio: 0.00008935882720915027,
        //esse circulo eh do que seria o p8, o menorzinho
        centro: {
          x: -19.939441,
          y: -43.998707
        }
      },
      {
        raio: 0.00008935882720915027,
        //p9
        centro: {
          x: -19.939521,
          y: -43.998850
        }
      },
      {
        raio: 0.00008935882720915027,
        // p9 tambem
        centro: {
          x: -19.939577,
          y: -43.998960
        }
      }
    ],
    videos: {
      bandex: '',
      p20: '',
      principal: '',
      decom: '',
      p18: '',
      p4: '',
      p5: '',
      depart: '',
      biblioteca: '',
      oficinas: '',
      p12: '',
      cemig: '',
      p19: '',
      portaria: ''
    }
  },
  {
    nome: "cemig",
    circulos: [{
      raio: 0.00009968951800459939,
      centro: {
        x: -19.938716,
        y: -44.000119
      }
    }],
    videos: {
      bandex: '',
      p20: '',
      principal: '',
      decom: '',
      p5: '',
      p4: '',
      p18: '',
      depart: '',
      oficinas: '',
      p12: '',
      p8e9: '',
      biblioteca: '',
      p19: '',
      portaria: ''
    }
  },
  {
    nome: "p19",
    circulos: [{
        raio: .0001015972440580406,
        centro: {
          x: -19.939842,
          y: -43.999406
        }
      },
      {
        raio: .0001015972440580406,
        centro: {
          x: -19.939832,
          y: -43.999243
        }
      }
    ],
    videos: {
      bandex: '',
      p20: '',
      principal: '',
      decom: '',
      p5: '',
      p4: '',
      p18: '',
      depart: '',
      oficinas: '',
      p12: '',
      p8e9: '',
      biblioteca: '',
      cemig: '',
      portaria: ''
    }
  },
  {
    nome: "portaria",
    circulos: [{
      raio: 0.00007766595135621686,
      centro: {
        x: -19.938274,
        y: -43.999333
      }
    }],
    videos: {
      bandex: '',
      p20: '',
      principal: '',
      decom: '',
      p5: '',
      p4: '',
      p18: '',
      depart: '',
      oficinas: '',
      p12: '',
      p8e9: '',
      cemig: '',
      p19: '',
      biblioteca: ''
    }
  }
];

// let paraOndeQueroIr = prompt('Qual prédio quer ir?');
// videoEl.src = predio.videos[paraOndeQueroIr]

function localizarPredio(geoLocalizacao) {
  let x = (geoLocalizacao.coords.latitude);
  let y = (geoLocalizacao.coords.longitude);
  let userDentroCirculo = false;
  let predioUser = null;

  for (let predio of predios) {
    for (let circulo of predio.circulos) {

      let distanciaUserACirculo = calculaDistancia({
          x: x,
          y: y
        },
        circulo.centro
      );

      userDentroCirculo = distanciaUserACirculo <= circulo.raio;

      if (userDentroCirculo) {
        predioUser = predio;
        break;
      }
    }
    if (userDentroCirculo) {
      break;
    }
  }
  // console.log(predioUser);

  return predioUser;
}


function calculaDistancia(a, b) {
  return Math.sqrt(Math.pow(a.x - b.x, 2) + Math.pow(a.y - b.y, 2));
}

function ativaDepuracaoDoMapeamentoDePredios() {
  // pega tamanho da imagem base
  const baseEl = document.querySelector('#mapa2 .base');
  const largura = baseEl.offsetWidth;
  const altura = baseEl.offsetHeight;

  // cria e configura um canvas
  const canvasEl = document.createElement('canvas');
  canvasEl.width = largura;
  canvasEl.height = altura;
  const nomeDaCamada = 'debug-predios';
  canvasEl.classList.add(nomeDaCamada, 'camada', 'images-mapa', 'visivel');
  canvasEl.style.transform = 'translate(0, 0) scale(1)';

  // solicita um contexto para desenharmos
  const ctx = canvasEl.getContext('2d');
  const UMA_VOLTA = 2 * Math.PI;
  const CORES = ['#51574a', '#447c69', '#74c493', '#8e8c6d', '#e4bf80', '#e9d78e', '#e2975d', '#f19670', '#e16552', '#c94a53', '#a34974', '#993767', '#65387d', '#4e2472', '#9163b6', '#e279a3', '#e0598b', '#7c9fb0', '#5698c4'];
  
  // percorre os prédios desenhando os círculos que o compõem
  for (let predio of predios) {
    const indiceCorAleatoria = Math.floor(Math.random() * CORES.length)
    const [corAleatoria] = CORES.splice(indiceCorAleatoria, 1);

    ctx.strokeStyle = corAleatoria;
    ctx.fillStyle = '#fff6';
    ctx.lineWidth = 2;

    for (let circulo of predio.circulos) {  
      // converte lat/lon para coordenadas do mapa
      const { x, y } = converteLatLonParaPorcentagem(circulo.centro.x, circulo.centro.y, window.campusAtual.usuarioPosicionado);
      const { x: xRaio, y: yRaio } = converteLatLonParaPorcentagem(circulo.centro.x + circulo.raio, circulo.centro.y, window.campusAtual.usuarioPosicionado);
      const raio = calculaDistancia({x: xRaio, y: yRaio} , { x, y });

      // desenha um círculo
      ctx.beginPath();
      ctx.arc(x * largura, y * altura, raio * altura, 0, UMA_VOLTA);
      ctx.stroke();
      ctx.fill();
    }
  }

  // insere o canvas como uma camada do mapa
  document.querySelector('#mapa2 .mapa-com-camadas').insertBefore(canvasEl, baseEl);
  window.mapasComCamadas[1].layers.push(canvasEl);

  // cria e insere um novo ativador de camada
  const templateAtivador = `
    <div class="custom-control custom-switch form-row">
      <input class="ativa-camada ${nomeDaCamada} custom-control-input" type="checkbox" id="ativa-debug-c2" value="${nomeDaCamada}" checked>
      <label for="ativa-debug-c2" class="custom-control-label">Depuração dos prédios</label>
    </div>
  `
  document.querySelector('#mapa2 .ativadores-de-camadas').innerHTML += templateAtivador;
}


// verifica se está em modo de debug
const urlSearchParams = new URLSearchParams(window.location.search);
const params = Object.fromEntries(urlSearchParams.entries());
const modoDebugAtivado = params['debug'] === 'true';

if (modoDebugAtivado) {
  const baseEl = document.querySelector('#mapa2 .mapa-com-camadas .base');
  document.addEventListener('campuschanged', () => {
    if (baseEl.complete) {
      ativaDepuracaoDoMapeamentoDePredios();
    } else {
      baseEl.addEventListener('load', ativaDepuracaoDoMapeamentoDePredios);
    }
  });
}
